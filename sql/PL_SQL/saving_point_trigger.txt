create or replace trigger saving_point
after insert on order_detail
for each row
declare
	v_total_price number := 0;
	v_order_id number;
	v_menu_id number;
	v_quantity number;
	v_menu_price number;
	v_point number;
	v_user_id number;
	v_user_info_point number;
begin
	v_order_id := :new.order_id;
	v_menu_id := :new.menu_id;
	v_quantity := :new.quantity;

	-- 해당 메뉴의 가격을 알아내기
	select
		price
	into v_menu_price
	from menu
	where menu_id = v_menu_id;

	-- 총 구매한 금액
	v_total_price := v_total_price + (v_quantity * v_menu_price);

	-- 적립되어야할 포인트
	v_point := round(v_total_price * 0.01);

	-- order_id를 통해 user_id 알아내기
	select
		user_id
	into v_user_id
	from user_order
	where order_id = v_order_id;

	-- 해당 유저의 원래 포인트 알아내기
	select
		point
	into v_user_info_point
	from user_info
	where user_id = v_user_id;

	-- 알아낸 user_id를 통해서 user_info의 포인트 갱신
	update user_info
	set point = v_user_info_point + v_point
	where user_id = v_user_id;

end;
